# Тестовое задание в Ozon Fintech
## Постановка задачи
Необходимо реализовать сервис, который должен предоставлять **API по созданию сокращенных ссылок** следующего формата:
1. Ссылка должна быть уникальной и на один оригинальный URL должна ссылаться только одна сокращенная ссылка 
2. Ссылка должна быть длинной 10 символов
3. Ссылка должна состоять из символов латинского алфавита в нижнем и верхнем регистре, цифр и символа «_»

В качестве хранилища использовать **PostgreSQL** и **память приложения**. Сервис должен быть распространён в виде Docker-образа. Весь функционал необходимо покрыть **Unit-тестами**.
## Сборка и запуск
Для конфигурации сервиса используется **.env** файл. В зависимости от "места" запуска, необходимо изменить значение **POSTGRESQL_HOST** в указанном файле. Для запуска на машине -- `POSTGRESQL_HOST=localhost`, для запуска в Docker -- `POSTGRESQL_HOST=postgresql`.

### Запуск без Docker
Не забудьте запустить **PostgreSQL**-сервер.
```
go run main.go
```
### Использование Docker
```
docker-compose up --build
```
### Запуск unit-тестов
```
go test ./tests
```
Для корректной работы Unit-тестов в **PostgreSQL** необходимо создать базу данных с символичным именем `tinyurl_test`.

Для тестов используется свой **env**-файл `testing.env`.


## Получение короткого URL
### Request
`POST /encode`
```
curl -i -H 'Accept: application/json' -d '{"url":"http://ya.ru"}' http://localhost:8080/encode
```
### Response
```
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Date: Thu, 09 Jun 2022 00:55:43 GMT
Content-Length: 69

{"code":0,"encodedUrl":"http://localhost:8080/upWycLjizj","error":""}

```
|code|error| http code | описание
--- | --- | --- | ---
0 | - | 200 | Запрос успешно обработан
1 | Invalid URL | 200 | Прислан невалидный URL
2 | Invalid request body | 400 | Неверный JSON
## Получение длинного URL
### Request
`GET /:short-url`
```
curl -i -H 'Accept: application/json' http://localhost:8080/upWycLjizj
```
### Response
```
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Date: Thu, 09 Jun 2022 00:58:24 GMT
Content-Length: 53

{"code":0,"decodedUrl":"http://ya.ru","error":""}
```
code | error | http code | описание
--- | --- | --- | ---
0 | - | 200 | Запрос успешно обработан
1 | Url not found | 200 | Указанный URL не содержится в базе данных
## Хранение данных
По условию задачи, в качестве хранилища необходимо использовать **PostgreSQL** и **память приложения**. Для единообразного и удобного использования любых типов хранилищ был определен интерфейс **Storage**, на который опираются реализации хэндлеров. Для внедрения нового типа хранилища достаточно определить структуру, удовлетворяющую  интерфейсу **Storage**. 

Поскольку подразумевается одновременное использование сервиса большим количество людей, в интерфейс **Storage** были добавлены методы **Lock()** и **Unlock()**, используемые для работы с мьютексом. Использование мьютекса обусловлено тем, что существует теоретическая возможность возникновения коллизий при одновременном выполнении нескольких POST-запросов к **/encode**.

Для выбора типа хранилища при запуске используется параметр `--db`.
### PostgreSQL
Нет необходимости дополнительно передавать параметр при запуске, поскольку  **PostgreSQL** используется приложением по умолчанию.
**Параметр для использования**: `--db=postgresql`
### Память приложения
Для хранения данных в памяти приложения используются две хеш-таблицы (отображение из короткого url в длинный и наоборот). Такое решение линейно по памяти и эффективно по времени (O(1) амортизированное). 
**Параметр для использования**: `--db=hash`

## Генерация случайных строк
Для генерации случайных строк был написан простой пакет **random**. Указанный пакет имеет в своем составе лишь одну функцию `func String(int) string`, возвращающую случайную строку заданной длины, состоящую из цифр, нижнего подчеркивания и букв латинского алфавита. 

## Валидация URL
Валидация URL осуществляется при помощи `url.ParseRequestURI` из `net/http`.
### Нюансы с завершающим "/"
В пакете `url` была разработана функция `func Truncate(string) string`, удаляющая идущие подряд "/" в конце URL. Однако, согласно различным [источникам](https://searchfacts.com/url-trailing-slash/), слэш, идущий в конце URL, играет важную роль, поэтому было принято решение отказаться от указанной функции. Описанная ситуация приводит к том, что с точки зрения сервиса, указанные URL будут различными:
``` 
http://ya.ru
http://ya.ru/
```
Для того чтобы вернуть старое поведение, достаточно раскомментировать указанную функцию в пакете `url` и одну строчку в `controllers/encode.go` (и не забыть про тесты).
